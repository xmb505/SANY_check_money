# IFLOW.md - 三一工学院自动查询水电费脚本项目

## 项目概述

这是一个用于自动查询三一工学院水电费信息的Python脚本项目，项目名为`sany_check_money`。主要功能包括：

1. **登录功能**：通过`login.py`脚本实现用户登录，并获取用户ID和角色ID等信息
2. **数据查询**：通过`get_data.py`脚本查询用户的水电费使用情况和余额
3. **签名验证**：实现了与目标网站（sywap.funsine.com）完全一致的签名算法，确保请求能够通过验证
4. **模块化设计**：脚本支持命令行调用，并返回JSON格式数据，便于其他模块集成和扩展
5. **邮件预警功能**：当水电费余额低于阈值时，自动发送邮件提醒用户
6. **后台监控功能**：通过`monitor_daemon.py`脚本实现周期性自动监控水电费余额

## 核心功能模块

### 1. 登录模块 (`login.py`)

- 使用MD5加密用户密码
- 生成符合网站要求的签名参数
- 发送登录请求并返回用户信息
- 支持命令行调用：`python3 login.py <手机号> <密码>`
- 返回JSON格式的登录结果，包含用户ID(appUserId)和角色ID(roleId)等关键信息

### 2. 数据查询模块 (`get_data.py`)

- 使用用户ID和角色ID查询水电费数据
- 实现与网站完全一致的签名算法
- 支持命令行调用：`python3 get_data.py <appUserId> <roleId>`
- 返回JSON格式的水电费数据，包含房间信息、使用量、余额等详细信息

### 3. 邮件预警模块

- 监控水电费余额，当低于预设阈值时自动发送邮件提醒
- 使用`mail_sender.py`脚本处理邮件发送逻辑
- 使用`mail_setting.ini`配置邮件发送参数
- 使用`mail_texter.txt`定义邮件模板格式
- 使用`monitor_config.ini`配置监控参数
- 支持多设备监控（电表和水表）

### 4. 后台监控模块 (`monitor_daemon.py`)

- 按照配置周期持续监控水电费余额
- 使用`monitor_config.ini`配置检查周期和预警阈值
- 当检测到余额低于阈值时，自动调用`mail_sender.py`发送预警邮件
- 支持命令行调用：`./monitor_daemon.py <账号> <密码>`
- 实现无人值守的自动化监控功能

## 核心技术实现

### 签名算法详解

签名算法是本项目的核心技术，完全模拟了目标网站的JavaScript实现：

- **签名密钥**：`DJKSBNW123`
- **算法流程**：
  1. 按参数名的字典序排序
  2. 将参数名和参数值都转换为大写
  3. 拼接成`KEY=VALUE&`格式
  4. 在末尾添加签名密钥
  5. 对拼接后的字符串进行MD5加密生成签名
- **时间戳格式**：`YYYYMMDDHHmmss`
- **渠道ID**：固定值`1003`

### 会话管理机制

本项目采用特殊的会话管理机制，不同于传统的Cookie方式：

- 通过URL参数维持会话状态
- 关键参数包括：`appUserId`、`roleId`、`channelid`、`timestamp`、`sign`
- 每次请求都需要重新生成签名，确保请求的有效性

## 项目文件说明

- `login.py`：用户登录脚本，接收手机号和密码作为参数，返回登录结果（包含appUserId和roleId）
- `get_data.py`：水电费数据查询脚本，接收appUserId和roleId作为参数，返回水电费详细信息
- `mail_sender.py`：邮件发送脚本，接收账号和密码参数，自动获取数据并发送邮件
- `monitor_daemon.py`：后台监控脚本，周期性检查水电费余额并在低于阈值时发送预警邮件
- `mail_setting.ini`：邮件发送配置文件
- `monitor_config.ini`：数据监控配置文件
- `mail_texter.txt`：邮件模板文件
- `README.md`：项目介绍和使用说明文档
- `IFLOW.md`：项目开发过程和技术细节说明文档
- `example.txt`：使用示例文件

## 使用方法示例

### 登录获取用户信息
```bash
python3 login.py 13800138000 password123
```

返回示例：
```json
{
  "msg": "操作成功",
  "code": 200,
  "user": {
    "appUserId": "12345",
    "phoneNum": "13800138000",
    "password": "想看密码吗？没门",
    "roleId": 201,
    "roleWxPayChannel": "1"
  }
}
```

### 查询水电费数据
```bash
python3 get_data.py 12345 201
```

返回示例：
```json
{
  "total": 2,
  "rows": [
    {
      "acctName": "学1栋101室电表",
      "currentDealDate": "2025-10-30 00:00:00",
      "remainingBalance": 50.00,
      "equipmentStatus": "开"
    },
    {
      "acctName": "学1栋101室水表",
      "currentDealDate": "2025-10-30 00:00:00",
      "remainingBalance": 30.00,
      "equipmentStatus": "开"
    }
  ],
  "code": 200,
  "msg": "查询成功"
}
```

### 发送邮件通知
```bash
./mail_sender.py <账号> <密码>
```

该命令会自动：
1. 调用`login.py`进行登录
2. 使用获取的用户信息调用`get_data.py`获取水电费数据
3. 使用`mail_texter.txt`模板生成邮件内容
4. 根据`mail_setting.ini`配置发送邮件

### 后台监控服务
```bash
./monitor_daemon.py <账号> <密码>
```

该命令会启动后台监控服务，按照 `monitor_config.ini` 中配置的检查周期持续监控水电费余额，
当余额低于设定阈值时自动发送邮件通知。

## 配置文件说明

### mail_setting.ini
邮件发送配置文件，包含：
- SMTP服务器地址
- 端口
- 用户名和密码
- 发件人和收件人信息
- 邮件加密方式

### monitor_config.ini
数据监控配置文件，包含：
- 检查周期（秒）
- 电表和水表的关键字识别
- 预警阈值设置

示例配置：
```ini
# 数据监控配置
[data]
# 检查周期，单位为秒
check_round = 3600
# 电表关键字，用于识别电表数据
ele_keyword = 电表
# 电表余额警报阈值
ele_num = 10
# 水表关键字，用于识别水表数据
water_keyword = 水表
# 水表余额警报阈值
water_num = 10
```

## 依赖项和环境要求

- Python 3.x
- `requests` 库用于HTTP请求
- `hashlib` 库用于MD5加密
- `json` 库用于数据格式处理
- `time` 库用于生成时间戳
- `sys` 库用于命令行参数处理
- `smtplib` 和 `email` 库用于邮件发送（邮件预警功能）
- `configparser` 库用于配置文件解析
- `subprocess` 库用于脚本间调用

## 项目特点和优势

1. **完全模拟网站行为**：所有请求参数和签名算法都与目标网站完全一致
2. **模块化设计**：登录、查询、邮件发送和监控功能分离，便于独立使用和扩展
3. **命令行友好**：支持命令行直接调用，返回标准JSON格式数据
4. **易于集成**：返回的数据格式便于其他系统集成和处理
5. **无会话依赖**：通过参数签名机制，无需维护复杂的会话状态
6. **智能预警**：新增邮件预警功能，及时提醒用户充值
7. **灵活配置**：支持通过配置文件自定义邮件和监控参数
8. **后台监控**：支持无人值守的自动化监控功能

## 后续扩展建议

1. **数据存储**：将查询到的水电费数据存储到数据库，便于历史数据分析
2. **Web界面**：开发Web界面，提供更友好的查询和展示方式
3. **定时任务**：使用cron等工具设置定时任务，实现自动化查询和预警
4. **多用户支持**：扩展系统以支持多个用户的水电费监控
5. **移动端应用**：开发移动端应用，方便用户随时查看水电费情况
6. **数据可视化**：添加数据图表功能，展示历史使用趋势

## 技术难点和解决方案

### 签名算法逆向工程
- **难点**：网站的签名算法较为复杂，且与标准实现略有差异
- **解决方案**：通过仔细分析网站JavaScript代码，完全模拟其实现过程

### 参数处理
- **难点**：参数的大小写处理和拼接顺序有特殊要求
- **解决方案**：严格按照网站的处理方式，先转大写再拼接

### 时间戳一致性
- **难点**：签名生成和请求发送需要使用相同的时间戳
- **解决方案**：在函数内部获取时间戳，确保一致性

### 邮件模板设计
- **难点**：需要设计灵活的邮件模板以适应不同设备的监控需求
- **解决方案**：使用占位符和`{{DATA_SECTION}}`系统，动态生成邮件内容
- **优化**：使用`{{DATA_SECTION}}`占位符避免注释中标签冲突问题

### 模块化设计
- **难点**：需要将登录、数据获取、邮件发送和监控功能分离
- **解决方案**：创建独立的脚本模块，通过`subprocess`调用协调使用

### 后台监控实现
- **难点**：需要实现周期性检查并在满足条件时触发邮件发送
- **解决方案**：使用`while True`循环配合`time.sleep()`实现周期性检查，通过配置文件控制检查周期