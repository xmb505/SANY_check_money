# IFLOW.md - 三一工学院自动查询水电费脚本项目

## 项目概述

这是一个用于自动查询三一工学院水电费信息的Python脚本项目，项目名为`sany_check_money`。主要功能包括：

1. **登录功能**：通过`login.py`脚本实现用户登录，并获取用户ID和角色ID等信息
2. **数据查询**：通过`get_data.py`脚本查询用户的水电费使用情况和余额
3. **签名验证**：实现了与目标网站（sywap.funsine.com）完全一致的签名算法，确保请求能够通过验证
4. **模块化设计**：脚本支持命令行调用，并返回JSON格式数据，便于其他模块集成和扩展

## 核心功能模块

### 1. 登录模块 (`login.py`)

- 使用MD5加密用户密码
- 生成符合网站要求的签名参数
- 发送登录请求并返回用户信息
- 支持命令行调用：`./login.py <账号> <密码>`
- 返回JSON格式的登录结果，包含用户ID(appUserId)和角色ID(roleId)等关键信息

### 2. 数据查询模块 (`get_data.py`)

- 使用用户ID和角色ID查询水电费数据
- 实现与网站完全一致的签名算法
- 支持命令行调用：`./get_data.py <appUserId> <roleId>`
- 返回JSON格式的水电费数据，包含房间信息、使用量、余额等详细信息

## 核心技术实现

### 签名算法详解

签名算法是本项目的核心技术，完全模拟了目标网站的JavaScript实现：

- **签名密钥**：`DJKSBNW123`
- **算法流程**：
  1. 按参数名的字典序排序
  2. 将参数名和参数值都转换为大写
  3. 拼接成`KEY=VALUE&`格式
  4. 在末尾添加签名密钥
  5. 对拼接后的字符串进行MD5加密生成签名
- **时间戳格式**：`YYYYMMDDHHmmss`
- **渠道ID**：固定值`1003`

### 会话管理机制

本项目采用特殊的会话管理机制，不同于传统的Cookie方式：

- 通过URL参数维持会话状态
- 关键参数包括：`appUserId`、`roleId`、`channelid`、`timestamp`、`sign`
- 每次请求都需要重新生成签名，确保请求的有效性

## 项目文件说明

- `login.py`：用户登录脚本，接收手机号和密码作为参数，返回登录结果（包含appUserId和roleId）
- `get_data.py`：水电费数据查询脚本，接收appUserId和roleId作为参数，返回水电费详细信息
- `README.md`：项目介绍和使用说明文档
- `IFLOW.md`：项目开发过程和技术细节说明文档

## 使用方法示例

### 登录获取用户信息
```bash
python3 login.py 13800138000 password123
```

返回示例：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "appUserId": "12345",
    "roleId": "67890",
    "userName": "张三"
  }
}
```

### 查询水电费数据
```bash
python3 get_data.py 12345 67890
```

返回示例：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "roomName": "1栋101室",
      "electricityBalance": "50.00",
      "waterBalance": "30.00",
      "electricityUsage": "100.50",
      "waterUsage": "60.20"
    }
  ]
}
```

## 依赖项和环境要求

- Python 3.x
- `requests` 库用于HTTP请求
- `hashlib` 库用于MD5加密
- `json` 库用于数据格式处理
- `time` 库用于生成时间戳

## 项目特点和优势

1. **完全模拟网站行为**：所有请求参数和签名算法都与目标网站完全一致
2. **模块化设计**：登录和查询功能分离，便于独立使用和扩展
3. **命令行友好**：支持命令行直接调用，返回标准JSON格式数据
4. **易于集成**：返回的数据格式便于其他系统集成和处理
5. **无会话依赖**：通过参数签名机制，无需维护复杂的会话状态

## 后续扩展建议

1. **邮件预警功能**：定期查询水电费余额，当低于阈值时发送邮件提醒
2. **数据存储**：将查询到的水电费数据存储到MySQL数据库，便于历史数据分析
3. **Web界面**：开发Web界面，提供更友好的查询和展示方式
4. **定时任务**：使用cron等工具设置定时任务，实现自动化查询

## 技术难点和解决方案

### 签名算法逆向工程
- **难点**：网站的签名算法较为复杂，且与标准实现略有差异
- **解决方案**：通过仔细分析网站JavaScript代码，完全模拟其实现过程

### 参数处理
- **难点**：参数的大小写处理和拼接顺序有特殊要求
- **解决方案**：严格按照网站的处理方式，先转大写再拼接

### 时间戳一致性
- **难点**：签名生成和请求发送需要使用相同的时间戳
- **解决方案**：在函数内部获取时间戳，确保一致性